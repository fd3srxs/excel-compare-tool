<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 比對工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS with Style support -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen flex flex-col items-center justify-center p-4 selection:bg-orange-100 selection:text-orange-800">

    <div
        class="max-w-2xl w-full bg-white/90 backdrop-blur-xl shadow-2xl rounded-3xl overflow-hidden border border-orange-100/50">

        <!-- Header Section -->
        <div class="bg-gradient-to-r from-orange-500 to-amber-500 p-8 text-center">
            <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">Excel 比對工具</h1>
        </div>

        <div class="p-8 space-y-8">
            <div class="space-y-6">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- File 1 Input -->
                    <div class="group">
                        <label for="file1"
                            class="block text-sm font-semibold text-gray-700 mb-2 group-hover:text-orange-600 transition-colors">
                            原始檔案 (File 1)
                        </label>
                        <div class="relative">
                            <input type="file" id="file1" accept=".xlsx, .xlsm" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2.5 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-bold
                                file:bg-orange-50 file:text-orange-700
                                hover:file:bg-orange-100
                                border border-gray-200 rounded-xl cursor-pointer bg-gray-50/50 hover:bg-white focus:outline-none focus:ring-2 focus:ring-orange-500/20 transition-all duration-200
                                ">
                        </div>
                    </div>

                    <!-- File 2 Input -->
                    <div class="group">
                        <label for="file2"
                            class="block text-sm font-semibold text-gray-700 mb-2 group-hover:text-amber-600 transition-colors">
                            新檔案 (File 2)
                        </label>
                        <div class="relative">
                            <input type="file" id="file2" accept=".xlsx, .xlsm" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2.5 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-bold
                                file:bg-amber-50 file:text-amber-700
                                hover:file:bg-amber-100
                                border border-gray-200 rounded-xl cursor-pointer bg-gray-50/50 hover:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 transition-all duration-200
                                ">
                        </div>
                    </div>
                </div>

                <button id="compareBtn"
                    class="w-full bg-gradient-to-r from-orange-500 to-amber-600 hover:from-orange-600 hover:to-amber-700 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg shadow-orange-500/30 transform hover:scale-[1.01] transition-all duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    開始比對並下載
                </button>

                <p id="status" class="text-center text-sm text-gray-600 hidden"></p>

                <!-- Results Container (Hidden by default) -->
                <div id="result-container" class="hidden space-y-6 animate-fade-in">
                    <!-- Download Action (Dynamically populated implies redundant but good to have persistent button) -->
                    <!-- We will just show tables here -->
                </div>
            </div>

            <!-- Info Section -->
            <div id="info-section" class="border-t border-gray-100 pt-8">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    使用說明
                </h2>

                <div class="grid md:grid-cols-2 gap-8 text-sm">
                    <!-- Rules -->
                    <div class="space-y-3">
                        <h3 class="font-semibold text-gray-700">1. 標題列偵測規則</h3>
                        <p class="text-gray-600 leading-relaxed">
                            系統會自動掃描前 20 行。若該行包含以下任一關鍵字（不分大小寫），即被視為標題列：
                        </p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span
                                class="px-2.5 py-1 bg-gray-100 text-gray-700 rounded-md font-mono text-xs border border-gray-200">ID</span>
                            <span
                                class="px-2.5 py-1 bg-gray-100 text-gray-700 rounded-md font-mono text-xs border border-gray-200">SKU</span>
                            <span
                                class="px-2.5 py-1 bg-gray-100 text-gray-700 rounded-md font-mono text-xs border border-gray-200">#</span>
                        </div>
                        <p class="text-xs text-orange-500 italic mt-2">* 網頁版目前僅支援基本逐格比對，部分進階邏輯可能略有不同。</p>
                    </div>

                    <!-- Legend -->
                    <div class="space-y-3">
                        <h3 class="font-semibold text-gray-700">2. 比對結果圖例</h3>
                        <ul class="space-y-2.5">
                            <li class="flex items-center gap-3 text-gray-600">
                                <span
                                    class="w-6 h-6 rounded bg-[#00FF00] border border-green-200 shadow-sm flex-shrink-0"></span>
                                <span>標題列 (Header)</span>
                            </li>
                            <li class="flex items-center gap-3 text-gray-600">
                                <span
                                    class="w-6 h-6 rounded bg-[#FFFF00] border border-yellow-200 shadow-sm flex-shrink-0"></span>
                                <span>比對關鍵欄位 (Key Column)</span>
                            </li>
                            <li class="flex items-center gap-3 text-gray-600">
                                <span
                                    class="w-6 h-6 rounded bg-white border border-red-200 shadow-sm flex items-center justify-center font-bold text-red-600 flex-shrink-0">A</span>
                                <span>差異數值 (紅色標示)</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center text-gray-400 text-xs">
        <p>Excel Comparison Tool v1.3 (Web Version)</p>
    </div>

    <script>
        document.getElementById('compareBtn').addEventListener('click', async () => {
            const file1Input = document.getElementById('file1');
            const file2Input = document.getElementById('file2');
            const status = document.getElementById('status');
            const btn = document.getElementById('compareBtn');
            const resultContainer = document.getElementById('result-container');
            const infoSection = document.getElementById('info-section');

            if (!file1Input.files[0] || !file2Input.files[0]) {
                alert('請選擇兩個檔案');
                return;
            }

            status.textContent = "處理中...";
            status.className = "text-center text-sm text-orange-600 animate-pulse";
            status.classList.remove('hidden');
            resultContainer.innerHTML = ''; // Clear previous results
            resultContainer.classList.add('hidden');
            infoSection.classList.remove('hidden');

            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const data1 = await readFile(file1Input.files[0]);
                const data2 = await readFile(file2Input.files[0]);

                const wb1 = XLSX.read(data1, { type: 'array' });
                const wb2 = XLSX.read(data2, { type: 'array' });

                const outputWb = XLSX.utils.book_new();

                // Process each sheet and build UI
                wb1.SheetNames.forEach(sheetName => {
                    const ws1 = wb1.Sheets[sheetName];
                    const ws2 = wb2.Sheets[sheetName];

                    const range = XLSX.utils.decode_range(ws1['!ref'] || "A1");

                    const newWs = {};
                    newWs['!ref'] = ws1['!ref'];
                    newWs['!cols'] = ws1['!cols'];
                    newWs['!merges'] = ws1['!merges'];

                    // UI Table Elements
                    const sheetWrapper = document.createElement('div');
                    sheetWrapper.className = 'border border-gray-200 rounded-xl overflow-hidden shadow-sm';
                    const sheetHeader = document.createElement('div');
                    sheetHeader.className = 'bg-gray-50 px-4 py-3 border-b border-gray-200';
                    sheetHeader.innerHTML = `<h4 class="font-semibold text-gray-700">工作表: ${sheetName}</h4>`;
                    sheetWrapper.appendChild(sheetHeader);

                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'overflow-auto max-h-[500px]';
                    const table = document.createElement('table');
                    table.className = 'w-full text-sm text-left whitespace-nowrap';
                    const tbody = document.createElement('tbody');

                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-100 hover:bg-gray-50/50';

                        let hasDiff = false;
                        const isHeader = (R === range.s.r);

                        // Use a temporary fragment to build row cells, so we can decide to append or not
                        const rowFragment = document.createDocumentFragment();

                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cellAddr = XLSX.utils.encode_cell({ r: R, c: C });
                            const cell1 = ws1[cellAddr];
                            const cell2 = ws2 ? ws2[cellAddr] : undefined;

                            // Determine cell value and styles for Calculation
                            if (!cell1) {
                                // Empty cell, still render td
                                const td = document.createElement('td');
                                td.className = 'px-4 py-2 border-r border-gray-100 last:border-r-0';
                                rowFragment.appendChild(td);
                                continue;
                            }

                            const newCell = {
                                t: cell1.t,
                                v: cell1.v,
                                w: cell1.w,
                                s: { font: { color: { rgb: "000000" } } }
                            };

                            let isDiff = false;

                            if (!cell2) {
                                isDiff = true;
                            } else if (cell1.v != cell2.v) {
                                isDiff = true;
                            }

                            let tdClass = 'px-4 py-2 border-r border-gray-100 last:border-r-0';

                            if (isDiff) {
                                newCell.s = {
                                    font: {
                                        color: { rgb: "FF0000" },
                                        bold: true
                                    }
                                };
                                tdClass += ' text-red-600 font-bold';
                                hasDiff = true;
                            }
                            newWs[cellAddr] = newCell;

                            // UI Cell
                            const td = document.createElement('td');
                            td.className = tdClass;
                            td.textContent = (cell1.v !== undefined) ? cell1.v : "";

                            if (isHeader) {
                                td.className += ' bg-green-100 font-semibold';
                            }

                            rowFragment.appendChild(td);
                        }

                        // Append row cells to tr
                        tr.appendChild(rowFragment);

                        // Only add row if header or diff
                        if (isHeader || hasDiff) {
                            tbody.appendChild(tr);
                        }
                    }
                    table.appendChild(tbody);
                    tableWrapper.appendChild(table);
                    sheetWrapper.appendChild(tableWrapper);
                    resultContainer.appendChild(sheetWrapper);

                    XLSX.utils.book_append_sheet(outputWb, newWs, sheetName);
                });

                XLSX.writeFile(outputWb, "comparison_result.xlsx");

                status.textContent = "完成！下載已開始，預覽如下(僅顯示差異)：";
                status.className = "text-center text-sm text-green-600 font-bold";

                // Show results, hide info
                resultContainer.classList.remove('hidden');
                infoSection.classList.add('hidden');

                // Add restart link at bottom
                const restartDiv = document.createElement('div');
                restartDiv.className = 'text-center pt-4';
                restartDiv.innerHTML = '<button onclick="window.location.reload()" class="text-sm text-gray-500 hover:text-orange-600 underline decoration-dashed">重新上傳檔案</button>';
                resultContainer.appendChild(restartDiv);


            } catch (err) {
                console.error(err);
                status.textContent = "錯誤: " + err.message;
                status.className = "text-center text-sm text-red-600";
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>

</html>